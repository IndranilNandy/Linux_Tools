#!/bin/bash

commandsRepoRoot="/usr/local/bin/mycommands"
scriptRefsRoot="/usr/local/bin/myscriptrefs"
configstore="$HOME/.myconfig"
configloader_src="$configstore/.configloader"
envloader="$configloader_src"/.envloader
refloader="$configloader_src"/.refloader

create_envstore() {
    [[ -d "$configloader_src" ]] || mkdir -p "$configloader_src"
    [[ -e "$envloader" ]] || touch "$envloader"

    [[ -d "$refloader" ]] ||  mkdir -p "$refloader"
}

create_symlinksrepo() {
    create_envstore
    [[ -d "$commandsRepoRoot" ]] || sudo mkdir $commandsRepoRoot
    [[ -d "$scriptRefsRoot" ]] || sudo mkdir $scriptRefsRoot

    # expPath="export PATH=$PATH:$commandsRepoRoot:$scriptRefsRoot"

    expPath="export PATH=$PATH"
    (echo "$expPath" | grep -E -v " *#" | grep -q "$commandsRepoRoot") || expPath="$expPath":"$commandsRepoRoot"
    (echo "$expPath" | grep -E -v " *#" | grep -q "$scriptRefsRoot") || expPath="$expPath":"$scriptRefsRoot"

    expCmdRoot="export MYCOMMANDSREPO=$commandsRepoRoot"
    expRefsRoot="export MYSCRIPTREFS=$scriptRefsRoot"
    expConfigLoader="export MYCONFIGLOADER=$configloader_src"
    expConfigStore="export MYCONFIGSTORE=$configstore"

    pattern="alias alert="
    loaderincluder="[[ -e $envloader ]] \&\& source $envloader"

    (cat "$envloader" | grep -E -v " *#" | grep -q "$commandsRepoRoot") || echo "$expPath" >>"$envloader"
    (cat "$envloader" | grep -E -v " *#" | grep -q "$expCmdRoot") || echo "$expCmdRoot" >>"$envloader"
    (cat "$envloader" | grep -E -v " *#" | grep -q "$expRefsRoot") || echo "$expRefsRoot" >>"$envloader"
    (cat "$envloader" | grep -E -v " *#" | grep -q "$expConfigLoader") || echo "$expConfigLoader" >>"$envloader"
    (cat "$envloader" | grep -E -v " *#" | grep -q "$expConfigStore") || echo "$expConfigStore" >>"$envloader"

    (cat ~/.bashrc | grep -E -v " *#" | grep -q "$loaderincluder") || sudo sed -i "/^$pattern/ s#\(.*\)#\1\n$loaderincluder#" ~/.bashrc

    . ~/.bashrc
}

if [[ ! -d $commandsRepoRoot ]]; then
    echo "mycommands repo doesn't exist. creating now..."
    create_symlinksrepo
    export PATH=$PATH:$commandsRepoRoot:$scriptRefsRoot
    export MYCOMMANDSREPO=$commandsRepoRoot
    export MYSCRIPTREFS=$scriptRefsRoot
    export MYCONFIGLOADER=$configloader_src
    export MYCONFIGSTORE=$configstore
fi
