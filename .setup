#!/bin/bash

. ./.systemConfig

add_execute_permission() {
    # Enable execution permission on all shell scripts
    # find . -name "*.sh" | xargs -n1 chmod +x
    find . -name "*.sh" -exec chmod +x {} \;
    # Enable execution permission on all .setup
    # find . -name ".setup" | xargs -n1 chmod +x
    find . -name ".setup" -exec chmod +x {} \;
    # Enable execution permission on all .int
    # find . -name ".int" | xargs -n1 chmod +x
    find . -name ".int" -exec chmod +x {} \;

    chmod +x ./.hack

    chmod +x ./Dev_tools_setup_scripts/k8/.tearCluster
    chmod +x ./Dev_tools_setup_scripts/k8/.initCluster
    chmod +x ./Dev_tools_setup_scripts/k8/.initClusterClients

    chmod +x ./.softclean

    chmod +x ./vars/.colors
    chmod +x ./_verify/.verify
    chmod +x ./.interactive_setup
}

add_execute_permission

. ./.configure
. ./vars/.colors

echo -e "\n${MAGENTA}[Linux_Tools] $(pwd)${RESET}"

# Installing moreutils explicitly before anything since all other modules need it
sudo apt list --installed | grep moreutils || (yes | sudo apt install moreutils)

missing_prereqs() {
    prereqfile=${1}

    missing=$(
        cat $prereqfile |
            xargs -I XYZ echo "[[ ! \$(apt --installed list 2> /dev/null | grep XYZ) && ! \$(which XYZ) ]] && echo 'XYZ'" |
            bash
    )

    echo "$missing"
}

install_explicit_prereqs() {
    yes | sudo apt install gawk
}

# Install missing prerequisites
export ToolsDir="$HOME/MyTools/Linux_Tools"
file=$(pwd)/.inittools

# TODO: Refactor this later to include list of tools
# Install gawk as prereq
install_explicit_prereqs

# hack needed for custom-setup for myinstaller
./.hack "$@"
missing_prereqs $file | xargs -I FILE find "$ToolsDir" -name FILE | xargs -I INPUT echo "(cd INPUT && find . -name .setup | bash)" | bash

# Exit if still missing any prerequisite
# export -f missing_prereqs
[[ $(missing_prereqs $file) ]] && echo -e "${RED}One or more prerequisites are still missing. Exiting.${RESET}" && exit 0

echo -e "${CYAN}\nAUTOMATED SETUP STARTED${RESET}"
echo $(pwd)/**/.* | xargs -n1 echo | grep '\.setup' | grep -E -v "exclude|_gsettings|Post_setup" | xargs -I INPUT echo "(cd \$(dirname INPUT) && echo INPUT "$*" | bash)" | bash
echo

# Install packages through sdkman
./usesdkman.sh

(
    cd ./_gsettings
    ./.setup
)
# (
#     cd ./_verify
#     # chmod +x .verify
#     ./.verify
# )
(
    cd ./Setup_stages/Post_setup
    ./.setup
)

# mycompl -W \"--type= --log-target= --custom-setup=\" .setup
echo -e "${CYAN}AUTOMATED SETUP FINISHED${RESET}"

# Start interactive setup
./.interactive_setup "$@"
./.manual_setup "$@"

echo -e "${MAGENTA}FULL SETUP COMPLETED${RESET}"

(
    cd ./_verify
    # chmod +x .verify
    ./.verify
)