#!/bin/bash

init_cluster_config() {
    cluscf=$(pwd)/config/defaults/.clusterconfigdefault
    machcf=$(pwd)/config/defaults/.machineconfigdefault

    for arg in "$@"; do
    #echo here
        case $arg in
        --clusterconfig=*)
            cluscf=$(echo "$arg" | sed "s/--clusterconfig=\(.*\)/\1/")
            ;;
        --machineconfig=*)
            machcf=$(echo "$arg" | sed "s/--machineconfig=\(.*\)/\1/")
            ;;
        *) ;;
        esac
    done

    echo -e "Cluster configuration file: $cluscf"
    echo -e "Machines configuration file: $machcf"
    echo -e

    yes | sudo ln -s -i "$cluscf" $(pwd)/config/.clusterconfig 2> /dev/null
    yes | sudo ln -s -i "$machcf" $(pwd)/config/.machineconfig 2> /dev/null
}

init_controlplane() {
    node_c=$(cat ./config/.clusterconfig | grep "controlplane:" | sed "s/controlplane: *\(.*\)/\1/" | tr " *" "\n" | xargs -I X echo X)

    # (./control-plane/controlplane_setup.sh "$node_c" || echo -e "[CONTROLPLANE] Setup failed in control plane $node_c")
    ! ./control-plane/controlplane_setup.sh "$node_c" && echo -e "[CONTROLPLANE] Setup failed in control plane $node_c" && exit 1

}

init_workers() {
    node_ws=$(cat ./config/.clusterconfig | grep "workers:" | sed "s/workers: *\(.*\)/\1/" | tr " *" "\n" | xargs -I X echo X)
    for w in $node_ws; do
        (./worker-node/worker_setup.sh "$w" || echo -e "[WORKER] Setup failed in worker node $w")
    done

    rm -rf ./credentials
}

init_clients() {
    clients=$(cat ./config/.clusterconfig | grep "clients:" | sed "s/clients: *\(.*\)/\1/" | tr " *" "\n" | xargs -I X echo X)
    for c in $clients; do
        (./clients/client_setup.sh "$c" || echo -e "[CLIENTS] Setup failed in client node $c")
    done
}

init_cluster_config "$@"
# init_controlplane
# init_workers
init_clients

