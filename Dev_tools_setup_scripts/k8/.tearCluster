#!/bin/bash

check_path() {
    path=./config/userdefined/"${1}"
    [[ -d "$path" ]] && [[ -e "$path"/.clusterconfig ]] && [[ -e "$path"/.machineconfig ]] || return 1
}

init_cluster_config() {
    cluscf=$(pwd)/config/defaults/.clusterconfigdefault
    machcf=$(pwd)/config/defaults/.machineconfigdefault

    passwd="amarbabamaa123!"
    echo $passwd | sudo -S whoami

    for arg in "$@"; do
        case $arg in
        --clusterconfig=*)
            cluscf=$(echo "$arg" | sed "s/--clusterconfig=\(.*\)/\1/")
            ;;
        --machineconfig=*)
            machcf=$(echo "$arg" | sed "s/--machineconfig=\(.*\)/\1/")
            ;;
        --configdir=*)
            dir=$(echo "$arg" | sed "s/--configdir=\(.*\)/\1/")
            ! check_path "$dir" && return 1
            cluscf=$(pwd)/config/userdefined/"$dir"/.clusterconfig
            machcf=$(pwd)/config/userdefined/"$dir"/.machineconfig
            ;;
        --promptpassword)
            export psdsource="prompt"
            ;;
        --filepassword)
            export psdsource="file"
            ;;
        *) ;;
        esac
    done

    echo -e "Cluster configuration file: $cluscf"
    echo -e "Machines configuration file: $machcf"
    echo -e

    yes | sudo ln -s -i "$cluscf" $(pwd)/config/.clusterconfig 2> /dev/null
    yes | sudo ln -s -i "$machcf" $(pwd)/config/.machineconfig 2> /dev/null
}

! init_cluster_config "$@" && echo -e "[CLUSTER TEARDOWN] Invalid cluster configuration information!" && exit 1

echo -e "[CLUSTER TEARDOWN] Starting to tear down cluster"
nodec=$(cat ./config/.clusterconfig | grep "controlplane:" | sed "s/controlplane: *\(.*\)/\1/" | tr " *" "\n" | xargs -I X echo X)

(./nodes/control-plane/controlplane_tear.sh "$nodec" || echo -e "[CLUSTER TEARDOWN] Tearing down cluster faced issues. See log for details")
