#!/bin/bash

declare -A mydirs

update_tab_completions() {
    mycompl -W '"'"${!mydirs[@]}" --list --config --refresh --help'"' qcd
    mycompl -W '"'"${!mydirs[@]}" --list --config --refresh --help'"' qcode
    mycompl -W '"'"${!mydirs[@]}" --list --config --refresh --help'"' qidea
    mycompl -W '"'"${!mydirs[@]}" --list --config --refresh --help'"' qn

    source ~/.bashrc
}

buildqcdmap() {
    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    mydirs=()
    mapfile -t entryArray <<<"$(grep -v "^ *#" <$curDir/.funcs/qcd/.mappings | xargs -I X echo X)"

    for line in "${entryArray[@]}"; do
        cdir=$(echo "$line" | awk '{ print $1 }')
        target=$(echo "$line" | awk '{ print $2 }')
        mydirs["$cdir"]="$target"
    done

    update_tab_completions
}

qcd() {

    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    buildqcdmap

    case ${1} in
    --list)
        cat "$curDir"/.funcs/qcd/.mappings
        ;;
    --config)
        editor "$curDir"/.funcs/qcd/.mappings
        echo -e "Run 'qcd --refresh' to enable tab-completions for this entry"
        ;;
    --refresh)
        update_tab_completions
        ;;
    --help)
        cat "$curDir"/.funcs/qcd/qcd.help
        ;;
    '')
        cat "$curDir"/.funcs/qcd/qcd.help
        ;;
    *)

        # REMEMBER: Don't call "source ~/.bashrc" inside buildqcdmap and after update_tabcompletions -> it'll be recursive
        # [[ -z ${mydirs[${1}]} ]] && buildqcdmap && source ~/.bashrc

        if [[ -z ${mydirs[${1}]} ]]; then
            (("$#" < 2)) && echo -e "Missing dir-target parameter" && return 1
            target="${2}"
            [[ "$target" == "." ]] && target=$(pwd)
            [[ $(echo "$target" | grep -F "/home/") ]] && target=$(echo "$target" | sed "s#/[^/]*/[^/]*\(/.*\)#\$HOME\1#")

            # echo -e "${1}:$target" >>"$curDir"/.funcs/qcd/.mappings
            echo -e "${1}\t\t\t$target" >>"$curDir"/.funcs/qcd/.mappings

            mydirs["${1}"]="$target"
            # update_tab_completions && source ~/.bashrc
            update_tab_completions
        else
            (("$#" == 2)) && echo -e "dir-alias already exists. Ignoring dir-target."
            if [[ ${2} == "--sudo" ]]; then
                # This still doesn't work, since this turns to root-user, and the .bashrc for the login user isn't executed
                targetDir="${mydirs[${1}]}"
                export targetDir
                eval "sudo su -; cd $targetDir"
            else
                eval "cd ${mydirs[${1}]}"
            fi
        fi
        ;;
    esac
}

qcode() {

    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    buildqcdmap

    case ${1} in
    --list)
        cat "$curDir"/.funcs/qcd/.mappings
        ;;
    --config)
        editor "$curDir"/.funcs/qcd/.mappings
        echo -e "Run 'qcode --refresh' to enable tab-completions for this entry"
        ;;
    --refresh)
        update_tab_completions
        ;;
    --help)
        cat "$curDir"/.funcs/qcd/qcode.help
        ;;
    '')
        cat "$curDir"/.funcs/qcd/qcode.help
        ;;
    *)
        (qcd "${1}" && code .)
        ;;
    esac
}

qidea() {

    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    buildqcdmap

    case ${1} in
    --list)
        cat "$curDir"/.funcs/qcd/.mappings
        ;;
    --config)
        editor "$curDir"/.funcs/qcd/.mappings
        echo -e "Run 'qidea --refresh' to enable tab-completions for this entry"
        ;;
    --refresh)
        update_tab_completions
        ;;
    --help)
        cat "$curDir"/.funcs/qcd/qidea.help
        ;;
    '')
        cat "$curDir"/.funcs/qcd/qidea.help
        ;;
    *)
        (qcd "${1}" && intellij-idea-community .)
        ;;
    esac
}

qn() {
    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    buildqcdmap

    case ${1} in
    --list)
        cat "$curDir"/.funcs/qcd/.mappings
        ;;
    --config)
        editor "$curDir"/.funcs/qcd/.mappings
        echo -e "Run 'qn --refresh' to enable tab-completions for this entry"
        ;;
    --refresh)
        update_tab_completions
        ;;
    --help)
        cat "$curDir"/.funcs/qcd/qn.help
        ;;
    '')
        cat "$curDir"/.funcs/qcd/qn.help
        ;;
    *)
        for dir in $(echo "$@" | xargs -n1); do
            eval "nautilus ${mydirs[$dir]}"
        done
        ;;
    esac
}

# No need call it here during .bashrc loading, it will increase load-time
# buildqcdmap
