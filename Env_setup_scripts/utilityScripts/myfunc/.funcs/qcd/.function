#!/bin/bash

declare -A mydirs

buildqcdmap() {
    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    for line in $(cat "$curDir"/.funcs/qcd/.mappings | xargs -I X echo X); do
        cdir=$(echo "$line" | cut -d':' -f1)
        target=$(echo "$line" | cut -d':' -f2)
        mydirs["$cdir"]="$target"
    done
    mycompl -W '"'"${!mydirs[@]}" --list --config --help'"' qcd
    mycompl -W '"'"${!mydirs[@]}" --list --config --help'"' qcode
}

qcd() {
    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    case ${1} in
    --list)
        cat "$curDir"/.funcs/qcd/.mappings
        ;;
    --config)
        editor "$curDir"/.funcs/qcd/.mappings
        ;;
    --help)
        cat "$curDir"/.funcs/qcd/qcd.help
        ;;
    '')
        cat "$curDir"/.funcs/qcd/qcd.help
        ;;
    *)
        [[ -z ${mydirs[${1}]} ]] && buildqcdmap
        eval "cd ${mydirs[${1}]}"
        ;;
    esac
}

qcode() {

    if [[ -z $(which myfunc) ]]; then
        curDir=$(pwd)
    else
        curDir=$(dirname "$(tracelink "$(which myfunc)")")
    fi

    case ${1} in
    --list)
        cat "$curDir"/.funcs/qcd/.mappings
        ;;
    --config)
        editor "$curDir"/.funcs/qcd/.mappings
        ;;
    --help)
        cat "$curDir"/.funcs/qcd/qcode.help
        ;;
    '')
        cat "$curDir"/.funcs/qcd/qcode.help
        ;;
    *)
        (qcd "${1}" && code .)
        ;;
    esac
}

buildqcdmap
