#!/bin/bash

# default values
installationType="(min|default)"
loggingDest="/dev/stdout"
errorDest="/dev/stdout"
cust_setup_def="No custom setup defined"

set_instType() {
    case ${1} in
    min)
        installationType="min"
        ;;
    default)
        installationType="(min|default)"
        ;;
    dev)
        installationType="(min|default|dev)"
        ;;
    full)
        installationType="min|default|dev|full"
        ;;
    *)
        exit 1
        ;;
    esac
}

set_logDest() {
    case ${1} in
    file)
        loggingDest=".logs"
        errorDest=".errors"
        ;;
    term)
        loggingDest="/dev/stdout"
        errorDest="/dev/stdout"
        ;;
    *) ;;

    esac
}

# This is a hack used to support custom-setup type for a minimal server etc. In future, you may think to refactor the code.
yes | sudo ln -s -i $(pwd)/myinstaller/fullAptPkgTools myinstaller/.fullAptPkgTools
yes | sudo ln -s -i $(pwd)/myinstaller/fullSnapPkgTools myinstaller/.fullSnapPkgTools


for arg in "$@"; do
    case $arg in
    --type=*)
        # options default, dev, full, minimal
        set_instType $(echo $arg | sed "s/--type=\(.*\)/\1/")
        ;;

    --log-target=*)
        #options file, term
        set_logDest $(echo $arg | sed "s/--log-target=\(.*\)/\1/")
        ;;

    --custom-setup=*)
        path=$(echo $arg | sed "s/--custom-setup=\(.*\)/\1/")
        [[ -n "$path" ]] && cust_setup_def=$(cat ../Custom_setup_definitions/$path/.$path)
        # TODO: Add support for passing snap tools list
        [[ -z "$path" ]] || yes | sudo ln -s -i $(pwd)/../Custom_setup_definitions/$path/.$path-aptpkgtools myinstaller/.fullAptPkgTools
        [[ -z "$path" ]] || yes | sudo ln -s -i $(pwd)/../Custom_setup_definitions/$path/.$path-snappkgtools myinstaller/.fullSnapPkgTools
        ;;

    *)
        echo "invalid arguments" && exit 1
        ;;
    esac
done

filter_tools() {
    xargs -I X echo "grep -E -q \"\$(basename \$(dirname X)).*${1}.*\" ./install.config && echo X" | bash
}

export loggingDest
export errorDest

sdkpkgs=$(pwd)/../.sdkmanpkgs

echo -e "\n${YELLOW}${BOLD}[Utility_tools_setup_scripts] [$(pwd)] Starting setup.${RESET}"
# echo $(pwd)/**/.* | xargs -n1 echo | grep '\.setup' | xargs -I INPUT echo -e "(cd \$(dirname INPUT) && echo -e \\n{\\nINPUT\\n} >> .logs 2>> .errors | bash)" | bash
# echo $(pwd)/**/.* | xargs -n1 echo | grep '\.setup' | xargs -I INPUT echo -e "(cd \$(dirname INPUT) && echo -e \\n{\\nINPUT\\n} >> >(ts '[%Y-%m-%d %H:%M:%S]' >> .logs) 2>> >(ts '[%Y-%m-%d %H:%M:%S]' >> .errors) | bash)" | bash
echo $(pwd)/**/.* | xargs -n1 echo | grep '\.setup' | grep -E -v "$cust_setup_def" | grep -E -v -f "$sdkpkgs" | filter_tools $installationType | xargs -I INPUT echo -e "(cd \$(dirname INPUT) && echo -e \"\\n{\\nINPUT\\n} >> >(ts '[%Y-%m-%d %H:%M:%S]' >> "$loggingDest") 2>> >(ts '[%Y-%m-%d %H:%M:%S]' >> "$errorDest")\" | bash)" | bash

# Reverting back to pointing fullAptPkgTools
yes | sudo ln -s -i fullAptPkgTools .fullAptPkgTools
yes | sudo ln -s -i fullSnapPkgTools .fullSnapPkgTools

echo -e "\n${GREEN}${BOLD}[Utility_tools_setup_scripts] [$(pwd)] Setup completed.${RESET}"
echo
